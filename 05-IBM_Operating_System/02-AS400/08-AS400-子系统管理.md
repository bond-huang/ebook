# AS400-子系统管理
官方参考链接：
- [IBM i 7.3 Subsystems](https://www.ibm.com/docs/zh/i/7.3?topic=concepts-subsystems)
- [IBM i 7.3 Managing subsystems](https://www.ibm.com/docs/zh/i/7.3?topic=work-managing-subsystems)

## 常用子系统任务
### 查看子系统属性
&#8195;&#8195;可以查看属性有：子系统的名称，包含子系统描述的库，子系统描述，子系统状态，子系统中的激活作业数量，子系统中最大激活作业数，子系同作业的名称用户和数量等。使用IBM Navigator for i查看：
- Work Management > Subsystems > Active Subsystems
- 选中需要查看的子系统，单击邮件选择`Properties`即可查看

使用命令`DSPSBSD`查看`QBATCH`的子系统描述：
```
DSPSBSD QBATCH
```
或者使用`WRKSBS`命令，选中需要查看的子系统，选择选项`5=Display subsystem description`。

### 启动子系统
使用IBM Navigator for i 启动：
- 展开 Work Management > Active Subsystems.
- 单击Actions > Start Subsystem
- 指明要启动的子系统的名称和库，然后单击`OK`

使用命令`STRSBS`示例，示例启动批处理子系统，名称为`QBATCH`：
```
STRSBS SBSD(QBATCH)
```
示例启动与`QGPL`库中的`TELLER`子系统描述相关联的子系统，子系统名称是 `TELLER`：
```
STRSBS SBSD(QGPL/TELLER)
```
说明：
- 命令 `STRSBS`命令使用命令中指定的子系统描述启动子系统
- 当子系统启动时，系统会分配子系统描述中指定的必要和可用资源(存储、工作站和作业队列)

### 停止子系统
方式停止：
- controlled(推荐)：以受控方式结束子系统，作业也以受控方式结束:
    - 允许正在运行的程序执行清理（作业处理结束）
    - 当正在结束的作业具有异步信号`SIGTERM`的信号处理过程时，将为该作业生成`SIGTERM`信号
    - 在作业结束之前，应用程序具有为`DELAY`参数指定的完成清理的时间量
- Immediate：立即结束子系统，作业也立即结束：
    - 当正在结束的作业具有异步信号`SIGTERM`的信号处理过程时，将为该作业生成`SIGTERM`信号并且`QENDJOBLMT`系统值指定时间限制
    - 除了处理`SIGTERM`信号外，不允许正在运行的程序执行任何清理

说明：
- 建议尽可能使用受控选项停止子系统，这允许活动作业自行结束
- 使用`controlled`可确保作业在子系统结束之前完成，这允许正在运行的程序执行清理（作业结束处理）
- 指定`Immediate`可能会导致不良结果

## 创建子系统描述
官方参考文档：[IBM i 7.3 Creating a subsystem description](https://www.ibm.com/docs/zh/i/7.3?topic=ms-creating-subsystem-description)
### 创建子系统描述方法
复制现有子系统描述：
- 创建现有子系统描述的重复对象，使用命令`CRTDUPOBJ`(Create a Duplicate Object)。或者使用使用`WRKOBJ`(Work with Objects)或`WRKOBJPDM`(Work with Objects using Programming Development Manager)命令
- 更改子系统描述的副本，使其按需要的方式运行：
    - 例如，需要删除作业队列条目，因为它标识了原始子系统使用的作业队列。然后您需要创建一个新的作业队列条目，指定新子系统使用的参数
    - 需要查看自动启动作业条目、工作站条目、预启动作业条目和通信条目，并确认两个子系统之间没有冲突。例如，验证workstation条目不会导致两个子系统分配相同的显示设备

创建全新的子系统描述：
- Create a Subsystem Description(CRTSBSD).
- Create a Job Description(CRTJOBD).
- 为Add Prestart Job Entry(ADDPJE)和Add Routing Entry(ADDRTGE)创建一个类：Create a Class(CRTCLS)
- 将工作条目添加到子系统描述中：
    - Add Workstation Entry(ADDWSE)
    - Add Job Queue Entry(ADDJOBQE)
    - Add Communications Entry(ADDCMNE)
    - Add Autostart Job Entry (ADDAJE)
    - Add Prestart Job Entry (ADDPJE)
- Add Routing Entries(ADDRTGE)到子系统描述中

### 添加自启动作业条目
&#8195;&#8195;当关联的子系统启动时，自动启动作业会自动启动。这些作业通常执行与特定子系统相关联的初始化工作。自动启动作业还可以执行重复性工作或为同一子系统中的其他作业提供集中服务功能。使用命令`ADDAJE`添加自启动作业条目，使用示例：
```
ADDAJE SBSD(ACCTLIB/ACCTINT) JOB(ACCTINIT) JOBD(ACCTLIB/INITSBS)
```
说明：
- 示例为库`ACCTLIB`中的作业`ACCTINIT`子系统描述`ACCTINT`添加自动启动作业条目
- 每当子系统`ACCTINT`启动时，自动启动的作业可能用于执行某些例程
- 当子系统启动时，`ACCTLIB`中的作业描述`INITSBS`用于获取该作业的属性，作业`ACCTINIT`在子系统中自动启动
- 要使更改生效，必须结束活动子系统然后重新启动

### 添加预启动作业条目
&#8195;&#8195;预启动作业条目可以在子系统启动或输入`STRPJ`命令时启动，使用命令`ADDPJE`来添加与启动作业条目，示例将预启动作业条目添加到子系统描述`ABC`中：
```
ADDPJE SBSD(USERLIB/ABC) PGM(START) JOBD(USERLIB/STARTPJ)
```
指定最大预启动作业数：
```
ADDPJE SBSD(QGPL/PJSBS) PGM(QGPL/PGM2) USER(PJUSER)
    MAXJOBS(100) CLS(QGPL/CLS1 75 QGPL/CLS2 *CALC) MAXUSE(50)
```
示例说明：
- 将`QGPL`库中`PGM2`程序的预启动作业条目添加到`QGPL`库中包含的`PJSBS`子系统描述中
- 指定该预启动作业在`PJUSER`用户配置文件下运行
- 此条目可以同时处于活动状态的最大预启动作业数为`100`
- 池中的每个预启动作业在作业结束前可以处理`50`个请求
- 如果此条目同时有`100`个预启动作业处于活动状态，则其中`75`个将使用`QGPL`库中的`CLS1`，其中`25`个将使用`QGPL`库中的`CLS2`
- 如果该条目的`50`个预启动作业同时处于活动状态，则所有`50`个作业都将使用`QGPL`库中的`CLS1`

### 添加作业队列条目
&#8195;&#8195;作业队列条目标识作业队列，从中选择作业在子系统中运行，从作业队列启动的作业是批处理作业。可以在作业队列条目中指定以下项目：
- JQBQ：作业队列名称
- MAXACT：作业队列中可同时处于活动状态的最大作业数
- SEQNBR：子系统从可以启动的作业中选择作业队列的顺序
- MAXPTYn：对于指定的作业队列优先级，可以同时处于活动状态的最大作业数

添加示例：
```
ADDJOBQE SBSD(QGPL/NIGHTSBS) JOBQ(QGPL/NIGHT) MAXACT(3)
```
说明：
- 将`QGPL`库中`NIGHT`作业队列的作业队列条目添加到`QGPL`库中`NIGHTSBS`子系统描述中
- 指定`NIGHT`作业队列中最多`3`个批处理作业可以在子系统中同时处于活动状态

### 添加通讯条目
&#8195;&#8195;每个通信条目描述一个或多个通信设备、设备类型或远程位置，当收到程序启动请求时，子系统将针对这些通信设备启动作业。使用命令`ADDCMNE`添加：
```
ADDCMNE SBSD(ALIB/SBS1) DEV(COMDEV)
```
示例说明：
- 示例中将名为`COMDEV`和模式`*ANY`(默认）的`APPC`设备的通信条目添加到库`ALIB`中`的子系统描述`SBS1`中
- `DFTUSR`参数默认为`*NONE`，除非在程序启动请求中提供了有效的安全信息，否则任何作业都不能通过此条目进入系统
- 用户必须指定`DEV`参数或`RMTLOCNAME`参数，但不能同时指定两者

### 添加路由条目
&#8195;&#8195;每个路由条目指定用于启动作业的路由步骤的参数。路由条目标识要使用的主存储子系统池、要运行的控制程序（通常是系统提供的程序QCMD）和附加运行时信息（存储在类对象中）。使用命令`ADDRTGE`添加：
```
ADDRTGE SBSD(QGPL/ABLE) SEQNBR(5) CMPVAL(XYZ)
    PGM(QGPL/REORD) CLS(LIBX/MYCLASS) MAXACT(*NOMAX)
```
示例说明：
- 示例将路由条目`5`添加到`QGPL`库中的子系统描述`ABLE`
- 当`XYZ`的比较值（从位置1开始）在路由数据中匹配时，库`QGPL`中的程序`REORD`被启动并使用`LIBX`中的类`MYCLASS`
- 该程序在ID为`1`的存储池中运行，并且允许的活动routing steps没有最大值

### 添加工作站条目
&#8195;&#8195;当用户登录或从另一个子系统传输交互式作业时启动作业时，将使用工作站条目。使用命令`ADDWSE`添加，示例如下：
```
ADDWSE SBSD(LIB7/ORDER) WRKSTN(A12) JOBD(LIB7/ORDER) AT(*ENTER)
```
示例说明：
- 示例将工作站`A12`的工作站作业条目添加到库`LIB7`中`ORDER`子系统描述中
- 与工作站`A12`关联的交互作业可以通过`Transfer Job(TFRJOB)`命令进入该子系统

### 创建登录显示文件
&#8195;&#8195;登录显示文件用于在分配给子系统的工作站上显示登录显示。当子系统处于活动状态时，可以更改登录显示文件,在下次启动子系统时才会使用新的登录显示文件。使用命令`CRTDSPF`(Create Display File)创建，具体参考官方文档。
### 指定新的登录显示
&#8195;&#8195;子系统使用在子系统描述的`SGNDSPF`参数(默认值QDSIGNON)中指定的登录显示文件在用户工作站上创建登录显示。使用命令`CHGSBSD`进行指定：
```
CHGSBSD SBSD(QSYS/QBATCH) SGNDSPF(MYSIGNON)
```
说明：
- 示例子系统`QBATCH`的登录显示文件从默认值更改为名为`MYSIGNON`的新文件
- 在尝试更改控制子系统之前，使用子系统的测试版本来验证显示是否有效

## 更改子系统描述
### 更改子系统描述方法
&#8195;&#8195;命令`CHGSBSD`更改指定子系统描述的操作属性。可以在子系统处于活动状态时更改子系统描述，但不能在`POOLS`参数上指定 `*RMV`值，作业可能会暂停。示例更改语言库，将子系统描述`SPANISH`更改为西班牙语辅助语言：
```
CHGSBSD SBSD(QGPL/SPANISH) SGNDSPF(QSYS2931/QDSIGNON) SYSLIBLE(QSYS2931)
```
### 更改条目
&#8195;&#8195;更改自动启动作业条目、更改预启动作业条目、更改作业队列条目、更改通信条目、更改路由条目、更改工作站条目以及更改登录显示和创建差不多，参考创建的说明和官方文档说明。
## 待补充