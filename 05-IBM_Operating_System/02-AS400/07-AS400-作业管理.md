# AS400-作业管理
官方参考链接：
- [IBM i 7.3 Jobs](https://www.ibm.com/docs/zh/i/7.3?topic=c-jobs)
- [IBM i 7.3 Managing jobs](https://www.ibm.com/docs/zh/i/7.3?topic=work-managing-jobs)

## 常见的Job任务
&#8195;&#8195;用户可以对作业执行的最常见的任务，包括启动、终止、查询等。可以使用IBM Navigator for i或者字符界面菜单及CL命令操作。参考链接：[IBM i 7.3 Common job tasks](https://www.ibm.com/docs/zh/i/7.3?topic=jobs-common-job-tasks)。
### 启动作业
官方参考链接：[IBM i 7.3 Starting a job](https://www.ibm.com/docs/zh/i/7.3?topic=tasks-starting-job)
#### 启动在作业队列中等待的批处理作业
&#8195;&#8195;可以将作业移到不忙的作业队列，首先检查作业所在的作业队列的状态，并确定将作业移至哪个队列最合适，Navigator操作查看步骤：
```
Work Management > All Tasks > Job Queues > Active Job Queues or All Job Queues
```
&#8195;&#8195;或将正在运行的作业搁置，然后优先移动需要启动的作业。使用此方法时要注意，因为挂起的作业仍包含在最大活动作业计数中。更改作业的优先级并指示应何时运行，操作步骤如下：
- 右键单击该作业，然后单击“Properties”。
- 在“Job Properties”窗口中，单击“Job Queue”选项卡
- 将“Priority on job queue”的“Priority”更改为更高的优先级（0 是最高的）
- 将“When to make job available to run”设置为“Now”或指定日期和时间
- 单击“OK”

#### 启动预启动作业
&#8195;&#8195;Prestart Job通常在子系统启动的同时启动。当预启动作业因错误被系统终止或子系统启动期间由于预启动作业属性 `STRJOBS(*NO)`为此时，需要手动启动。可以同时处于活动状态的预启动作业的数量受预启动作业属性上的`MAXJOBS`属性和子系统的`MAXJOBS`属性的限制。使用示例：
```
STRPJ SBS(SBS1) PGM(PJLIB/PJPGM)
```
示例说明：
- 示例为子系统`SBS1`中的预启动作业条目`PJPGM`发起启动，`PJPGM`在库`PJLIB`中
- 发出此命令时，子系统`SBS1`必须处于活动状态
- 已启动的作业数是在预启动作业条目`PJPGM`的`INLJOBS`值中指定的数量

### 结束作业
官方参考链接：[IBM i 7.3 Ending a job](https://www.ibm.com/docs/zh/i/7.3?topic=tasks-ending-job)
#### 结束作业:controlled
&#8195;&#8195;以受控方式结束作业，可以指定延迟时间，如果延迟时间在作业结束前结束，则作业会立即结束。CL命令使用示例：
```
ENDJOB JOB(001234/HQ/JOB1) OPTION(*CNTRLD) DELAY(50) SPLFILE(*NO)
```
示例说明：
- 此命令结束名为`001234/HQ/JOB1`的作业
- 假脱机输出保存为假脱机写入器的正常处理
- 作业有50秒的时间来执行清理例程，之后立即结束
- 可以通过`RTVJOBA`(Retrieve Job Attributes)CL命令来检索作业的结束状态

#### 结束作业:immediate
&#8195;&#8195;立即结束作业时，可能会有意外结果，例如部分更新的应用程序数据。仅当受控结束不成功时才使用立即结束选项。CL命令示例：
```
ENDJOB JOB(*) OPTION(*IMMED)
ENDJOB JOB(JOB1) OPTION(*IMMED) SPLFILE(*YES)
```
示例说明：
- 第一个示例为立即结束当前作业
- 第二个示例为立即结束`JOB1`作业，作业产生的Spool File删除，作业日志保存

当使用立即结束选项时，系统执行最少的作业结束处理，其中可能包括：
- 关闭数据库文件
- 将作业日志和Spool File到输出队列
- 清理操作系统中的内部对象
- 显示作业结束显示（用于交互式作业）
- 完成递交的控制处理

### 查找作业
查找作业常用命令说明：

命令|描述|示例
:---|:---|:---
WRKACTJOB|Work with Active Jobs|WRKACTJOB SBS(QBATCH)
WRKUSRJOB|Work with User Jobs|WRKUSRJOB USER(BONDHUANG)
WRKSBMJOB|Work with Submitted Jobs|WRKSBMJOB *USER
WRKSBSJOB|Work with Subsystem Jobs|WRKSBSJOB SBS(QBATCH)

### 查看作业队列中的作业
IBM Navigator for i查看步骤：
```
Work Management > All Tasks > Job Queues > Active Job Queues or All Job Queues
```
&#8195;&#8195;字符界面使用命令`WRKJOBQ`显示系统上所有可用作业队列的列表。找到需要查看作业队列后，选择选项`5=Work with`显示作业队列中的所有作业。或使用`WRKSBSJOB`命令来显示作业队列及其各自的作业:
```
WRKSBSJOB SBS(*JOBQ)
```
### 查看作业属性
&#8195;&#8195;作业属性包含有关如何处理作业的信息，它们最初是在创建作业时指定的，一些属性来自工作描述。IBM Navigator for i中找到对应作业直接右键即可查看属性。CL命令查看：  
- 命令`WRKJOB`。当作业处于活动状态时可以查看以下信息：作业运行属性、调用堆栈信息、作业锁定信息、库列表信息、作业日志信息、打开文件信息、文件覆盖信息、提交控制状态、通信状态、激活组信息、互斥信息和线程信息
- 命令`DSPJOB`。此命令显示有关作业的以下信息：作业状态属性、作业定义属性、作业运行属性、假脱机文件信息、作业日志信息、调用堆栈信息、作业锁定信息、库列表信息、打开文件信息、文件覆盖信息、承诺控制状态、通信状态、激活组信息、互斥信息、线程信息、媒体库和属性信息

### 查看调用堆栈
&#8195;&#8195;命令`WRKJOB`或`DSPJOB`选择选项`11. Display call stack, if active`。如果查看线程的调用堆栈，选择选项`20. Display threads, if active`，然后选择选项`10=Display call stack`。
### 将作业放入作业队列
以下是使用字符界面将新作业放置在新作业队列中的方法：
- 提交作业`SBMJOB`：允许正在运行的作业将另一个作业提交到作业队列，以便稍后作为批处理作业运行。只能将请求数据的一个元素放置在新作业的消息队列中。如果用于作业的路由条目指定了CL命令处理程序，则请求数据可以是CL命令
- 添加作业计划条目`ADDJOBSCDE`：系统在作业计划条目中指定的时间和日期自动将作业提交到作业队列
- 提交数据库作业`SBMDBJOB`：将作业提交到作业队列，以便它们可以作为批处理作业运行。此命令允许用户指定此数据库文件及其成员的名称、要使用的作业队列的名称，并决定是否可以通过`WRKSBMJOB(Work with Submitted Jobs)`命令来显示正在提交的作业
- 启动数据库读取器`STRDBRDR`：从数据库读取批处理输入流并将一个或多个作业放置在作业队列中
- 移动作业`TFRJOB`：将当前作业移动到活动子系统中的另一个作业队列
- 移动批处理作业`TFRBCHJOB`：将当前作业移动到另一个作业队列

### 将作业移动到不同的作业队列
&#8195;&#8195;有时由于长时间运行的作业，作业会积压在队列中；或者作业的计划运行时间与具有更高优先级的新作业冲突。解决这种情况的一种方法是将等待的作业移到另一个相对闲的队列中。可以使用`CHGJOB`命令，例如将作业`JOBA`移动到作业队列`JOBQB`：
```
CHGJOB JOB(JOBA) JOBQ(LIBA/JOBQB)
```
### 作业队列中调整作业的优先级
&#8195;&#8195;作业队列中的所有作业都排队等待处理，队列中作业的处理顺序取决于作业的优先级，以及子系统上可以同时运行的最大作业数。作业队列中作业的优先级有助于确定作业何时进入子系统运行。从0到9的范围（0是最高）决定了作业队列中作业的优先级。    
&#8195;&#8195;命令`CHGJOB`中参数`JOBPTY`是关于优先级的，输入`CHGJOB`命令后按`F4`,然后按`F9`可以看到更多属性选项，命令示例：
```
CHGJOB JOB(PAYROLL) JOBPTY(4)
```
说明：
- 该命令将作业`PAYROLL`的调度优先级更改为`4`
- 由于只指定了作业的简单名称，因此系统中只能存在一个名为`PAYROLL`的作业。如果有多个，默认的`DUPJOBOPT(*SELECT)`会导致在交互式作业中显示选择面板

### 设置工作优先级的技巧
官方参考链接：[IBM i 7.3 Tips for setting job priorities](https://www.ibm.com/docs/zh/i/7.3?topic=tasks-tips-setting-job-priorities)
### 提交一次性作业
&#8195;&#8195;需要立即或在预定的日期和时间运行一次作业时，可以使用`SBMJOB(Submit Job)`命令,此方法立即将作业放入作业队列：
- `SBMJOB`命令将作业提交到批处理作业队列通过指定作业描述和指定CL命令或请求数据或指定路由数据来运行程序
- 如果要在批处理作业中运行单个CL命令，在`SBMJOB`上使用`CMD`参数，它会进行语法检查并提示

&#8195;&#8195;使用示例，例如`SBMJOB`命令使用作业描述`QBATCH`将名为`WSYS`的作业提交到作业队列`QBATCH`，`CMD`参数给出将在作业中运行的CL命令:
```
SBMJOB JOBD(QBATCH) JOB(WSYS) JOBQ(QBATCH) CMD(WRKSYSSTS)
```
### 查看作业关联信息
使用IBM Navigator for i：
- Work Management > Active Jobs
- 选中需要查看的Job，右键选择`Properties`
- 在弹出页面上，选择`Memory and processor affinity`即可查看

使用字符界面输入命令`WRKJOB`，选择选项`Display job run attributes, if active`。

## 待补充

