# AS400-备份与恢复
&#8195;&#8195;AS400系统中进行备份恢复通常使用BRMS，全称Backup, Recovery, and Media Services，用于规划和管理IBM i产品上的保存和恢复操作。官方参考链接：
- [Backup, Recovery, and Media Services(BRMS)](https://www.ibm.com/docs/zh/i/7.3?topic=recovery-backup-media-services-brms)
- [IBM i 7.3备份与恢复](https://www.ibm.com/docs/zh/i/7.3?topic=management-backup-recovery)

## SAVE Files
官方参考链接：
- [IBM i 7.3 Save files](https://www.ibm.com/docs/zh/i/7.3?topic=media-save-files)
- [Working with save files](https://www.ibm.com/docs/zh/i/7.3?topic=sf-working-save-files)

### GO SAVE命令
GO SAVE命令菜单选项示例：
```
 Save Data                       
    1. Files                     
    2. Libraries                 
    3. Documents and folders     
    4. Programs                  
    5. Other objects             
    6. Changed objects only      
    7. Licensed programs         
    8. Security data             
                                 
   10. Configuration             
   11. Objects in directories   
                                                       
Save System and User Data                              
  20. Define save system and user data defaults        
  21. Entire system                                    
  22. System data only                                 
  23. All user data                                    
                                                       
Save Document Library Objects                          
  30. All documents, folders, and mail                 
  31. New and changed documents, new folders, all mail 
  32. Documents and folders                            
  33. Mail only   
                                                  
 Save Libraries                                   
   40. All libraries other than system library    
   41. All IBM libraries other than system library
   42. All user libraries                         
   43. All changed objects in user libraries      
                                                  
 Save for Different Systems                       
   50. Save in System/36 format                   
                                                  
 Related Commands                                 
   70. Related commands                                                                
```
官方参考链接：
- [IBM i 7.3 Overview of the GO SAVE command](https://www.ibm.com/docs/en/i/7.3?topic=system-overview-go-save-command)
- [IBM i 7.3 GO SAVE command menu options](https://www.ibm.com/docs/en/i/7.3?topic=command-go-save-menu-options)

### Save and Restore LIB
#### Save LIB
使用命令`SAVLIB`,示例将`PFRLIB`保存到SAVF`SAVFLIB/PFRSAVF`：
```
SAVLIB LIB(PFRLIB) DEV(*SAVF) SAVF(SAVFLIB/PFRSAVF)
```
也可以保存到媒体设备，示例将`PFRLIB`使用drive TAP01报错：
```
SAVLIB LIB(PFRLIB) DEV(TAP01)
```
官方参考文档：[IBM i Save Library(SAVLIB)](https://www.ibm.com/docs/zh/i/7.3?topic=ssw_ibm_i_73/cl/savlib.htm)
#### Restore LIB
&#8195;&#8195;使用命令`RSTLIB`,如果是SAVF，在恢复前可以使用命令`DSPSAVF`命令查看SAVF相关信息。示例恢复上面`SAVLIB`的第一个示例：
```
RSTLIB SAVLIB(PFRLIB) DEV(*SAVF) SAVF(SAVFLIB/PFRSAVF)
```
示例恢复新的对象：
```
RSTLIB SAVLIB(PFRLIB) DEV(TAP01) OPTION(*NEW)
```
示例说明：
- 示例从磁带设备TAP01恢复库PFRLIB的保存版本
- 库中唯一恢复的对象是新对象（保存时在库中但后来被删除的对象）

官方参考文档：[IBM i Restore Library(RSTLIB)](https://www.ibm.com/docs/zh/i/7.3?topic=ssw_ibm_i_73/cl/rstlib.htm)
### Save and Restore OBJ
#### Save OBJ
使用命令`SAVOBJ`，例如保存CS数据对象为SAVF：
```
SAVOBJ OBJ(Q287102629) LIB(QPFRDATA) 
    DEV(*SAVF) SAVF(PFRLIB/PFR1014)
```
示例保存保存同名的程序和文件到磁带设备：
```
SAVOBJ OBJ(PETE) LIB(LIBXXX) DEV(TAP01)
```
示例说明：
- 示例保存位于`LIBXXX`库中名为`PETE`的对象
- 如果`LIBXXX`包含一个程序和一个名为`PETE`的文件，那么这两个对象都会被保存
- 由于`STG`参数默认值是`(*KEEP)`，因此不会释放对象占用的存储空间

官方参考文档：[IBM i Save Object(SAVOBJ)](https://www.ibm.com/docs/zh/i/7.3?topic=ssw_ibm_i_73/cl/savobj.htm)
#### Restore OBJ
使用命令`RSTOBJ`，恢复`SAVOBJ`中的第一个示例：
```
RSTOBJ OBJ(Q287102629) SAVLIB(QPFRDATA) 
    DEV(*SAVF) SAVF(PFRLIB/PFR1014)
```
示例恢复最近保存的版本：
```
RSTOBJ OBJ(PAYROLL) SAVLIB(LIBX) DEV(TAP01)
    OBJTYPE(*PGM) VOL(*SAVVOL)
```
示例说明：
- 示例将从`LIBX`库中保存的名为`PAYROLL`的程序恢复到`LIBX`
- 磁带驱动器`TAP01`用于恢复最近保存的程序版本

Restore说明：
- 如果需要从SAVF恢复性能数据，Restore选项中`Saved library`(SAVLIB)填入名称必须和保存时候一致
- 可以将数据恢复到其它库，需要在`Restore to library`中填入指定的LIB
- 如果不知道保存时候的LIB和OBJ名称，可以通过命令`DSPSAVF`可以查看

官方参考文档：[IBM i Restore Object(RSTOBJ)](https://www.ibm.com/docs/zh/i/7.3?topic=ssw_ibm_i_73/cl/rstobj.htm)
### Save时候压缩选项
&#8195;&#8195;使用`SAVLIB`和`SAVOBJ`命令时，有压缩参数`DTACPR`(Data compression)可以对保存的数据进行压缩，特别是性能数据收集时，压缩很有必要，选项有：
- `*DEV`：默认选项      
- `*NO`：不压缩    
- `*YES` ：压缩，测试压缩CS数据可以压到默认的一半 
- `*LOW `：低压缩
- `*MEDIUM`：中度压缩 
- `*HIGH`：高度压缩，测试压缩CS数据可以到默认的六分之一，和7Z差不多 

## 常见问题
官方参考链接：[备份与恢复的常见问题](https://www.ibm.com/docs/zh/i/7.3?topic=recovery-backup-faq)
## BRMS
参考链接：
- [IBM i 7.3 Backup and Recovery Log](https://www.ibm.com/docs/zh/i/7.3?topic=system-backup-recovery-log)

### 备份策略配置
&#8195;&#8195;在将磁带库驱动映射给主机后，可以通过`WRKHDWRSC *STG`命令查看到，`WRKMLBSTS`里面也有，可以开始通过BRMS配置备份策略。假设系统中认到的磁带库名称是：TAPMLB08。
#### 初始化BRM
&#8195;&#8195;此时通过`WRKMLMBRM`不能看到磁带信息，需要`CRTDEVMLB`，如果已经存在，需要初始化一下，初始化后，通过命令`WRKMLMBRM`可以看到磁带，初始化命令如下：
```
INZBRM OPTION(*RUNPRDINZ)
```
命令参考链接：[Initialize BRMS (INZBRM)](https://www.ibm.com/docs/zh/i/7.3?topic=ssw_ibm_i_73/cl/inzbrm.htm)
#### 创建Media Class
创建步骤如下：
- 运行命令`GO BRMS`
- 选择选项`1. Media management`
- 选择选项`1. Work with media classes`
- `Opt`第一行中输入`1`进行添加，然后输入Class名称，例如叫`VTLTEST`
- 确认后回车，进入配置选项页面，例如`Density`选项输入磁带类型，例如`*ULTRIUM3`
- 建议输入描述文本，其他选项根据需求或者默认即可
- 完成按`Enter`确认

#### 添加磁带到Media Class
添加步骤如下：
- 输入命令`WRKMLMBRM`,可以看到所有磁带
- 在没有分类的磁带中，前面输入`1`选择将要移动的磁带
- 回车进入`Add Media Library Media to BRM`页面：
  - `Media library`输入需求的Media library名称，例如之前创建的`TAPMLB08`
  - `Add volume to BRM`选择`*YES`
  - `Initialize media`选择`*YES`，注意，不初始化可能使用不了
  - `Media class`输入需要移动到的Media Class，例如之前创建的`VTLTEST`
  - 其他选项可以默认，完成按`Enter`确认
- 可以使用命令`WRKMEDBRM MEDCLS(VTLTEST)`命令查看，默认应该是`*EXP`状态

#### 创建Media policy
创建步骤如下：
- 运行命令`GO BRMS`
- 选择选项`11. Policy administration`
- 选择选项`7. Work with media policies`
- `Opt`第一行中输入`1`进行添加，然后输入Class名称，例如叫`VTLTEST`：
  - `Retain type`是设置下面选项的单位，例如按天是`2=Days`
  - `Retain media`是media过期时间，根据需求设置
  - `Move policy`此次配置未添加，以后再搞
  - `Media class`输入这个策略对应的Media class，例如之前创建的`VTLTEST`
  - 其他选项根据需求进行设置，默认也可以
  - 完成按`Enter`确认

#### 创建Backup planning
创建步骤如下：
- 运行命令`GO BRMS`
- 选择选项`2. Backup`
- 选择选项`1. Backup planning`
- 选择选项`2. Work with backup control groups`：
  - 例如创建`Control Group`名称为`TESTBK`
  - 根据需求添加`Save Item`，为对象或库名称
  - 指定`ASP Device`
  - `Weekly Activity SMTWTFS`是备份计划，根据需求指定
  - `Incremental Media Policy`指定之前创建的Media Policy，例如叫`VTLTEST`
  - `Full Media Policy`依旧是之前创建的，例如叫`VTLTEST`
  - `Retain Object Detail`选项选择`*YES`
  - 完成后按`Enter`确认
- 回到`Backup planning`菜单，选择`3. Display backup plan`查看配置

## 系统备份
官方参考链接：[IBM i7.3 备份系统](https://www.ibm.com/docs/zh/i/7.3?topic=recovery-backing-up-your-system)
### 磁带备份整个系统
&#8195;&#8195;注意，备份需要停到系统大多数子系统，此时系统不能进行业务。准备好磁带，将一盒空磁带挂到对应的TAP上。
#### 停掉用户子系统
&#8195;&#8195;运行`WRKSBS`查看运行的子系统，如果有用户的子系统，手动停掉用户所有的子系统。注意，如果是重要系统，停止前可能需要应用部门确认。
#### 停掉系统
&#8195;&#8195;输入`ENDSYS`命令停掉系统的大多数子系统，系统将处于受限状态。等待若干分钟，只剩下`QCTL`子系统。
#### 发起备份
步骤如下：
- 运行命令`GO SAVE`
- 选择选项`21. Entire system`
- 进入`Save the Entire System`页面，提示会进行的操作：
  - End all subsystems
  - Save the Licensed Internal Code
  - Save the operating system
  - Save the security data
  - Save the device configuration objects
  - Save all user libraries(including libraries for licensed programs)
  - Save all documents and folders
  - Save all distribution and mail objects
  - Save all directories
  - Start the controlling subsystem
- 也有不会做的操作：Save the contents of job queues or data queues that exist the system
- 回车确认后进入`Specify Command Defaults`页面：
  - 选项`Devices`输入备份的设备，例如`TAPMLB08`
  - 其他默认，或者根据需求设置
- 回车确认后进入`End Subsystem`页面，根据需求设置
- 回车确认后进入`Save System`页面，主要是磁带机配置，根据需求配置
- 回车后，开始备份，查看状态
- 备份完成后子系统会启动

## 磁带备份用户数据
### 通过BRMS备份
&#8195;&#8195;在`BRMS`章`备份策略配置`节配置好备份策略后，可以直接通过命令发起备份，或者通过定时任务，或者程序实现计划性备份。假设Control Group名称为`TESTBK`，命令示例如下：
```
STRBKUBRM CTLGRP(TESTBK) SBMJOB(*NO) JOBQ(QBATCH) ACTIVITY(*CTLGRPATR)   
```
## 待补充